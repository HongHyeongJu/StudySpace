## 유데미 Redis : 개발자를 위한 Redis 완벽 가이드
### ch.16 - 전자 상거래 앱을 활용해 실습하기

<br>
<br>

* 일부분 건너뜀

<br>
<br>


### 114. 동시성 문제 이해하기
* 입찰 시 같은 요청이 왔을 때 각자의 실행선에서 처리하므로 여러명이 낙찰받을 수 있음
* Redis에서는 데이터를 가져와 계산 작업이나 검증 작업을 수행한 다음 다시 Redis에 저장해야 하는 상황이라면 언제나 이와 비슷한 동시성 문제가 발생할 수 있음
* 데이터를 가져오는 시점과 Redis에 다시 저장 및 업데이트하는 시점 사이에 다른 요청 또는 다른 프로세스가 동일한 작업을 수행할 수 있기 때문에 다른 프로세스와 충돌이 일어날 수 있어요
* 언제든지 데이터를 읽어오고 + 무언가를 처리한 다음 + 다시 저장 및 업데이트할 때 => 동시성 문제가 발생할 가능성 있음!!!
* 동시성 문제를 진짜 문제로 볼 건지 아닌지는 애플리케이션 규칙에 따라 달라짐
  * ex) 
  * Todo List에서 '시작', '완료' 요청이 겹치는 경우 -> 큰문제 아님. 마지막 정보로 업데이트 하거나 권한을 이용할 수있음
  * 낙찰 등 돈관련 중요한 문제에서는 조심해야함
* 동시성 문제 해결방법 4가지
  * 2가지는 이번 챕터에서, 나머지는 후반에 설명
  * [1] 자동 업데이트 commeand 사용하기 (HINCRBY or HSETNX)
  * [2] WATCH 명령어로 트랜젝션 사용하기
  * [3] 락 이용하기
  * [4] LUA 업데이트 스크립트를 커스텀 하기


<br>


### 원자적 업데이터 적용하기
* 동시성 문제의 원인
  * 데이터를 읽고 쓰는 사이에 시간 차가 존재하기 때문
  * 바로 이 시간 동안 다른 요청이 서버로 들어와서 현재 읽고 있는 데이터를 업데이트할 수 있기 때문에
* 특정 명령어를 이용하면 데이터를 읽어오지 않고 현재 값을 사용해 제자리에서 업데이트 할 수 있음
* 해결하는 방법 중 하나는 inStock의 초깃값을 확인하는 단계를 생략하는것 = 읽는 단계를 전부 생략하고 바로 쓰는 단계로 넘어가기
  * 이렇게 하려면 ‘HINCRBY’ 명령어를 쓰기 (해시에 대해 설명할 때 다뤘음)
  * 쓰는 동작만 수행하며, 읽는 동작은 수행하지 않음
* ex) 이번에는 차량 색상을 기록하기 + 한 가지 요구사항(아직 색상이 지정되지 않은 차량에 대해서만 색상을 지정해야함)
  * 'HSETNX'를 사용하기 (HSETNX 명령어는 프로퍼티가 설정되지 않는 경우에 한해 값을 설정함)
* HINCRBY, HSETNX 명령어의 핵심
  * 이를 사용해 읽고 쓰는 동작 사이의 시간 차를 완벽히 제거할 수 있음
  * 또는 일정 기준을 만족하는 경우에만 업데이트를 수행하게할 수 있음
* 하지만 대부분의 경우에는 이 명령어만으로 문제를 해결할 수 없음
  * 입찰 데이터 생성시 HSET뿐만 아니라 RPUSH도 사용함
  * 또한 리스트 처리시 HSETNX 같은 명령어는 큰 도움이 되지 않음
  * 그래서 트랜잭션이 필요함


<br>


### 트랜잭션
* 여러 개의 명령을 그룹으로 묶어 순차적으로 실행될 수 있도록 보장해줌
* Redis에서는 트랜잭션 롤백과 취소는 할 수 없음(그래서 다른 데이터베이스에 비해 트랜잭션의 활용도가 떨어짐)
* MULTI
  * Redis에게 곧 여러 개의 명령어를 보낼 거고, 바로 실행하지는 않을 거라는 뜻
  * 조금 기다렸다가 나중에 차례대로 실행할 때 사용함
  * MULTI를 사용해서 트랜잭션을 시작한 다음에는, 실제로 실행할 명령어들을 전송함
  * ‘QUEUED’라는 메세지 : 명령어가 대기열에 추가되어 실행을 기다리고 있음을 의미함
* EXEC
  * 실행할 명령어들을 실제로 실행하게 함


<br>


### 트랜잭션으로 키 감시하기
* WATCH
  * Redis가 특정 키에 저장된 값을 지켜보도록 지시함
  * 다음 트랜잭션이 실행되기 전에 지켜보던 값이 변경되면, 해당 트랜잭션은 자동으로 실패함
  * 지켜보던 키가 변경되었다면 EXEC를 호출하는 순간 null이 반환됨
* Redis에서 값을 읽어온 다음, 잠시 시간을 들여 처리 작업을 진행하고, 다시 쓰기 작업을 실행하는 경우에는 일련의 과정을 모두 트랜잭션으로 감싸주고, WATCH 명령어를 사용하기
* WATCH 키워드에서 자주 볼 수 있는 전형적인 사용 패턴 알아두기

<br>


### 트랜잭션용 연결 분리
* 자주 사용되는 패턴
  * WATCH => 데이터 가져오기 => 트랜잭션 실행
    * WATCH 실행
    * GET, HGETALL 등의 명령어로 Redis에서 데이터 가져오기
    * 데이터 처리하기
    * MULTI, SET, EXEC로 트랜잭션을 구성하기
* 주의점
  * 트랜잭션을 사용하면 WATCH나 MULTI키워드를 호출할 때마다 Redis과의 연결을 완전히 점유하게됨
  * 해당 연결은 이 트랜잭션만 사용할 수 있게 되고, 다른데서는 사용할 수 없음

<br>


### 트랜잭션으로 중복 입찰 문제 해결하기
* 필기
* 필기
* 필기
* 필기
* 필기

<br>


### 가격순 정렬 & 함수 구현
* 필기
* 필기
* 필기
* 필기
* 필기




