## 보안
유데미 강의 270~

### 학습 커리큘럼
* 인증
* 인가
* 스프링시큐리티 기초
* 스프링시큐리티 필터 체인
* Form, Basic, JWT
* CSRF, CORS...
* OAuth


### 1. 보안의 기초
어떤 시스템이던 **리소스**가 있음 (RESR API, 웹 애플리케이션, 데이터베이스 등등)
그리고 **ID**가 있음 (사용자 등)
ID는 리소스에 액세스하고, 이 리소스를 대상으로 여러 가지 작업을 수행함
사용자가 액세스 할 수 있는 리소스와, 사용자가 리소스별로 수행할 수 있는 작업을 설정해야함

### 2. 보안의 원칙
강한 아키텍처로 만든 앱도 작은 보안 결함으로 취약해질 수 있음.

[ 애플리케이션 빌드 보안 6원칙 ]
* Trust Nothing
  * 아무것도 신뢰하지 말고 들어오는 모든 요청을 검증해야함
  * 시스템에 들어오는 모든 데이터나 정보를 검증해야함
* Assign Least Privileges
  * 최소 권한 할당
  * 시스템 설계를 시작할 때 처음부터 보안을 염두하기
  * 각 사용자에게 필요한 사용자 역할과 액세스 권한을 명확히 정해야 함
  * 모든 레벨에서 가능한 한 최소한의 권한을 할당하기(애플리케이션 레벨, 인프라 레벨 또한 마찬가지)
* Have Complete Mediation
  * 완벽한 조율 구축
  * ex) 중세시대 - 모두 하나의 문을 통과해야 했음
  * 애플리케이션이나 시스템에도 효과적으로 구현된 보안 필터가 필요함
  * 요청이 들어올 때마다 액세스 권한을 확인해야함
* Have Defense In Depth
  * 심층적인 방어 구조
  * 보안도 여러 층으로 구축해야함(전송 레이어, 네트워크 레이어, 인프라, 운영체제 레벨, 애플리케이션 레벨)
* Have Economy Of Mechanism
  * 보안 아키텍처를 가능한 한 간단하게 유지하는 것(간단한 시스템이 보호하기 더 쉬움)
  * 메커티즘 효율성이 필요함
* Ensure Openness Of Design
  * 설계의 개방성을 보장하기
  * 개방형 보안 설계를 구축하고 개방형 보안 표준을 사용하기(ex JWT)


== (예시) 공항에 보안 6원칙 적용하기 ==
1. Trust Nothing : 공항을 이용하는 모든 사람은 여권이나 신분증 인증을 거친다.
2. Assign Least Privileges : 모든 사람이 할당된 이상의 권한을 남용하지 않도록 각 레벨에서 보안 검사를 수행함
3. Have Complete Mediation : 공항의 입구는 명확하게 정해저있고 입구에서 인증하고 권한을 받음, 자격을 확인 받아야 비행기에 탑승이 가능함
4. Have Defense In Depth : 여권 탑승권 여러번 확인함. 보안 게잍, 보안 검색대, 탑승 전
5. Have Economy Of Mechanism : 보안 절차는 매우 간단
6. Ensure Openness Of Design : 전 세계 모든 공항에서 표준 보안 시스템이 적용되고 있음




<br>
<br>
<br>

### 스프링 시큐리티의 개괄적 작동 원리
* 사전에 필요한 지식
  * 스프링 MVC
  * 필터 작동 원리
* 필터 체인 기능
  * 스프링시큐리티는 요청이 들어오자마자 일련의 필터를 실행함 : 스프링 시큐리티 필터체인
  * 인증확인 : 적절한 사용자?
  * 인가확인 : 사용자가 적절한 액세스 권한을 보유했는가?
  * CORS(Cross-Origin Resource Sharing) : 오리진 간 리소스 공유 설정 
  * CSRF(Cross site Request Forgery) : 사이트 간 요청 위조, 
  * 기본 로그인 페이지, 로그아웃 페이지 제공
  * 인증과 권한 부여 관련해 예외가 발생할 때 적절한 HTTP 응답으로 변환
* 필터들은 특정한 순서대로 실행됨.
  * 요청에 대한 CORS, CSRF
  * 사용자 인증
  * 권한 확인
  

<br>
<br>
<br>

### 살펴보기
* 스프링부트 3.XX 버전과 JDK17 설치
* 폼 기반 인증
  * 로그인 폼에 자격 증명을 입력하고 버튼을 누르면 로그인 되는 방식
  * 백그라운드에서는 세션 쿠키가 생성됨
* 스프링 시큐리티는 기본적으로 폼 기반 인증을 사용해서 설정함
  * 기본 로그인 페이지, 기본 로그아웃 페이지, /logout URL 제공
* 기본 컨트롤러 만들고 주소 입력하니 기본 로그인 창 뜸
  * Spring Security가 요청을 인터셉트해서 로그인 페이지로 리디렉션하는 것
  * 로그인 하려면 기본 ID 는 user, 비밀번호는 로그에 나와있음
````
Using generated security password: 9c660592-4af3-4d24-9d1b-07a78ff6c664
````
  * 로그인 이후에 네트워크의 요청을 확인하면 쿠키가 생성되어있음을 알 수 있음
* 없는 URL을 입력하면 이미 인증을 거쳤어도 쿠키가 요청과 함께 전송되며 스프링 시큐리티가 자동으로 인증함
* 없는 페이지인 경우 : Whitelable Error Page 오류
* 사용자 로그인 -> 세션ID 생성 -> 이 세션 ID는 쿠키로 이후의 모든 요청과 함께 전송됨




<br>
<br>
<br>

### 기본 인증의 작동 방식
* Base 64 인코딩 사용자 이름과 패스워드가 요청 헤더로 전송됨
* 사용자가 REST API에 액세스하려고 하면 헤더에 권한 부여 헤더를 추가할 수 있음
  * 권한 부여 헤더 : Basic 다음에 Base 64 인코딩 사용자 이름과 패스워드가 나열되는 형식
* Talend API Tester는 REST API 테스트에 유용한 Chrome 확장 프로그램
* 권한 부여 헤더를 전송 방법
  * Type : Authorization
  * Username : user
  * Password : 로그의 비밀번호
  * set 버튼 누르기
* 생성된 권한 헤더
  * Basic dXNlcjo5OGM3Y2FjMC00NWNjLTRhZmMtOWMzZC0wOGRkMWE3ZTA1MzE=
  * Basic : 기본 인증이라는 의미 + (공백) + 인코딩된 사용자 이름과 패스워드가 표시
* 기본 인증은 REST API에 보안을 적용하는 기본적인 옵션
* 그러나 단점이 많아서 프로덕션 환경용으로 권장되지 않음
  * [단점] 
  * 이 Base 64 인코딩을 디코딩하기가 쉽기 때문에 권한 부여 헤더를 획득하게 된다면 누구라도 쉽게 사용자 이름과 패스워드를 알아낼 수 있음
  * 기본 권한 부여 헤더에는 권한 부여 정보가 없음. ID PW만 존재하고 사용자 액세스 권한이나 역할에 관한 정보가 없음
  * 만료일이 없음. 기본 권한 부여 헤더를 생성하면 영구적으로 유효
* 앞으로의 테스트를 위해 username과 password를 정적으로 지정하기
  * application.properties 파일
````
spring.security.user.name=hello
spring.security.user.password=world
````

    














